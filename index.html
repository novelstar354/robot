<!doctype html>

<html lang="ja">
<head>
<meta charset="utf-8">
<title>人間確認（防御レベルMAX）</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
html,body{margin:0;height:100%;background:#020617;color:#e5ecff;font-family:system-ui}
.wrap{display:grid;place-items:center;height:100%}
.box{background:#0f172a;padding:20px;border-radius:16px;width:340px;text-align:center;box-shadow:0 0 30px #000}
button{padding:10px 16px;border-radius:10px;border:none;background:#2563eb;color:#fff;font-size:14px;margin:6px}
canvas{background:#020617;border-radius:14px;margin-top:12px;touch-action:none}
.hidden{display:none}
.lock{color:#f87171;font-weight:bold}
.ok{color:#22c55e;font-weight:bold}
.warn{color:#facc15}
</style>
</head>
<body>
<div class="wrap">
 <div class="box">
  <h2>人間確認</h2>
  <label><input type="checkbox" id="chk"> 私はロボットではありません</label>
  <p id="env" class="warn"></p>
  <div id="q" class="hidden">
   <p id="qtext"></p>
   <div id="answers"></div>
   <canvas id="cv" width="280" height="280" class="hidden"></canvas>
  </div>
  <p id="msg"></p>
 </div>
</div>

<script>
/************ 基本状態 ************/
let correct=0,fail=0,entropy=0;
const chk=document.getElementById('chk');
const q=document.getElementById('q');
const msg=document.getElementById('msg');
const qtext=document.getElementById('qtext');
const answers=document.getElementById('answers');
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d');
let goal,x,y,r=12,drag=false,hold=null;

/************ 環境判定（軽量） ************/
const env=document.getElementById('env');
if(!('ontouchstart' in window)){
 env.textContent='※ スマートフォン操作が推奨されます';
}
if(navigator.webdriver){ entropy+=2; }
if(navigator.hardwareConcurrency<=2){ entropy++; }

/************ ロック管理（段階式） ************/
const BASE_LOCK=5*60*1000;
let lockLevel=parseInt(localStorage.getItem('lockLv')||'0');
const lockedUntil=parseInt(localStorage.getItem('lockUntil')||'0');
if(Date.now()<lockedUntil){
 msg.innerHTML='<span class="lock">あなたはロボットです<br>'+(lockLevel+1)+'段階ロック中</span>';
 chk.disabled=true;
}

chk.onchange=()=>{ if(chk.checked) nextQuestion(); };

/************ 問題制御 ************/
function nextQuestion(){
 q.classList.remove('hidden');
 answers.innerHTML='';
 cv.classList.add('hidden');
 msg.textContent='';
 const pool=['calc','color','compare','drag','gesture','memory'];
 const t=pool[Math.floor(Math.random()*pool.length)];
 ({calc:calcQ,color:colorQ,compare:compareQ,drag:dragQ,gesture:gestureQ,memory:memoryQ})[t]();
}

function success(){
 correct++; q.classList.add('hidden');
 if(correct>=2 && entropy<5){
  msg.innerHTML='<span class="ok">確認完了。移動します…</span>';
  setTimeout(()=>location.href='https://example.com',2000);
 }else{
  setTimeout(nextQuestion,600);
 }
}

function failure(){
 fail++; correct=0; entropy++;
 q.classList.add('hidden');
 if(fail>=5 || entropy>=6){
  lockLevel++;
  localStorage.setItem('lockLv',lockLevel);
  const lockTime=BASE_LOCK*Math.pow(2,lockLevel);
  localStorage.setItem('lockUntil',Date.now()+lockTime);
  msg.innerHTML='<span class="lock">あなたはロボットです<br>'+(lockTime/60000)+'分ロック</span>';
  chk.disabled=true;
 }else{
  setTimeout(nextQuestion,600);
 }
}

/************ 問題群 ************/
function calcQ(){
 const a=rand(5,20),b=rand(5,20);
 qtext.textContent=`${a}+${b}は？`;
 shuffle([a+b,a+b+rand(1,3),a+b-rand(1,3)]).forEach(v=>btn(v,v===a+b));
}

function colorQ(){
 const map={赤:'#f87171',青:'#60a5fa',緑:'#4ade80'};
 qtext.textContent='文字と同じ「色」を選んでください';
 const keys=shuffle(Object.keys(map));
 qtext.style.color=map[keys[1]];
 keys.forEach(k=>btn(k,k===keys[1]));
}

function compareQ(){
 const a=rand(10,99),b=rand(10,99);
 qtext.textContent=`大きい方は？ (${a} / ${b})`;
 btn(a,a>b);btn(b,b>a);
}

function dragQ(){
 qtext.textContent='円を中心で2秒間保持してください';
 cv.classList.remove('hidden');
 goal={x:140,y:140,r:32}; x=40;y=140; draw();
 cv.onpointerdown=()=>drag=true;
 cv.onpointerup=()=>{drag=false;hold&&clearTimeout(hold);hold=null};
 cv.onpointermove=e=>{
  if(!drag)return;
  const rct=cv.getBoundingClientRect();
  x=e.clientX-rct.left;y=e.clientY-rct.top;
  const d=Math.hypot(x-goal.x,y-goal.y);
  if(d<=goal.r){ if(!hold) hold=setTimeout(()=>{draw(false);success();},2000); }
  else{ hold&&clearTimeout(hold);hold=null; }
  draw();
 };
}

function gestureQ(){
 if(!('ontouchstart' in window)) return nextQuestion();
 cv.classList.remove('hidden'); answers.innerHTML='';
 const patterns=['Z','circle','LRD','UD','zigzag','reverseC','spiral'];
 const p=patterns[Math.floor(Math.random()*patterns.length)];
 qtext.textContent='ジェスチャー：'+p;
 let path=[]; ctx.clearRect(0,0,cv.width,cv.height); ctx.beginPath();
 cv.onpointerdown=e=>{drag=true;path=[[e.offsetX,e.offsetY]];ctx.moveTo(e.offsetX,e.offsetY)};
 cv.onpointermove=e=>{ if(!drag)return; path.push([e.offsetX,e.offsetY]); ctx.lineTo(e.offsetX,e.offsetY); ctx.strokeStyle='#22c55e'; ctx.stroke(); };
 cv.onpointerup=()=>{drag=false;checkGesture(p,path)};
}

function memoryQ(){
 qtext.textContent='3秒後に消える順番を覚えてください';
 const seq=shuffle(['▲','●','■']).slice(0,3);
 qtext.textContent=seq.join(' ');
 setTimeout(()=>{
  qtext.textContent='順番通り選んでください'; answers.innerHTML='';
  seq.forEach((v,i)=>btn(v,i===0?true:false));
 },3000);
}

function checkGesture(p,path){
 if(path.length<15) return failure();
 const sx=path[0][0],sy=path[0][1];
 const ex=path.at(-1)[0],ey=path.at(-1)[1];
 const dx=ex-sx,dy=ey-sy;
 if(p==='circle'&&Math.abs(dx)<30&&Math.abs(dy)<30) return success();
 if(p==='Z'&&dx>60&&dy>40) return success();
 if(p==='LRD'&&dx>40&&dy>40) return success();
 if(p==='UD'&&Math.abs(dx)<30&&dy>60) return success();
 if(p==='zigzag'&&path.some((p,i)=>i>5&&Math.sign(path[i][0]-path[i-5][0])<0)) return success();
 if(p==='reverseC'&&dx<0&&Math.abs(dy)<40) return success();
 if(p==='spiral'&&Math.abs(dx)<40&&Math.abs(dy)<40&&path.length>30) return success();
 failure();
}

/************ 共通 ************/
function btn(txt,ok){ const b=document.createElement('button'); b.textContent=txt; b.onclick=()=>ok?success():failure(); answers.appendChild(b); }
function draw(showGoal=true){ ctx.clearRect(0,0,cv.width,cv.height); if(showGoal){ctx.beginPath();ctx.arc(goal.x,goal.y,goal.r,0,Math.PI*2);ctx.strokeStyle='#22c55e';ctx.stroke();} ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle='#60a5fa';ctx.fill(); }
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function shuffle(a){return a.sort(()=>Math.random()-0.5)}
</script>

</body>
</html>
