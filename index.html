<!doctype html>

<html lang="ja">
<head>
<meta charset="utf-8">
<title>人間確認（フル統合版）</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
html,body{margin:0;height:100%;background:#020617;color:#e5ecff;font-family:system-ui}
.wrap{display:grid;place-items:center;height:100%}
.box{background:#0f172a;padding:20px;border-radius:14px;width:320px;text-align:center}
button{padding:10px 16px;border-radius:8px;border:none;background:#2563eb;color:#fff;font-size:14px;margin:4px}
canvas{background:#020617;border-radius:12px;margin-top:12px;touch-action:none}
.hidden{display:none}
.lock{color:#f87171;font-weight:bold}
.ok{color:#22c55e}
</style>
</head>
<body>
<div class="wrap">
 <div class="box">
  <h2>人間確認</h2>
  <label><input type="checkbox" id="chk"> 私はロボットではありません</label>
  <div id="q" class="hidden">
   <p id="qtext"></p>
   <div id="answers"></div>
   <canvas id="cv" width="260" height="260" class="hidden"></canvas>
  </div>
  <p id="msg"></p>
 </div>
</div>

<script>
let correct=0,fail=0;
const LOCK=5*60*1000;
const chk=document.getElementById('chk');
const q=document.getElementById('q');
const msg=document.getElementById('msg');
const qtext=document.getElementById('qtext');
const answers=document.getElementById('answers');
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d');
let goal,x,y,r=12,drag=false,hold=null;

// ロック判定
const locked=localStorage.getItem('lock');
if(locked && Date.now()<locked){
 msg.innerHTML='<span class="lock">あなたはロボットです<br>5分間ロック中</span>';
 chk.disabled=true;
}

chk.onchange=()=>{ if(chk.checked) nextQuestion(); };

function nextQuestion(){
 q.classList.remove('hidden');
 answers.innerHTML='';
 cv.classList.add('hidden');
 msg.textContent='';
 const types=['calc','color','compare','drag','gesture'];
 const t=types[Math.floor(Math.random()*types.length)];
 if(t==='calc') calcQ();
 if(t==='color') colorQ();
 if(t==='compare') compareQ();
 if(t==='drag') dragQ();
 if(t==='gesture') gestureQ();
}

function success(){
 correct++;
 q.classList.add('hidden');
 if(correct>=2){
  msg.innerHTML='<span class="ok">確認完了。移動します…</span>';
  setTimeout(()=>location.href='https://example.com',2000);
 }else{
  setTimeout(nextQuestion,500);
 }
}

function failure(){
 fail++;
 correct=0;
 q.classList.add('hidden');
 if(fail>=5){
  localStorage.setItem('lock',Date.now()+LOCK);
  msg.innerHTML='<span class="lock">あなたはロボットです<br>5分間ロックされました</span>';
  chk.disabled=true;
 }else{
  setTimeout(nextQuestion,500);
 }
}

// 計算
function calcQ(){
 const a=Math.floor(Math.random()*10),b=Math.floor(Math.random()*10);
 qtext.textContent=`${a}+${b}は？`;
 [a+b,a+b+1,a+b-1].sort(()=>Math.random()-0.5).forEach(v=>btn(v,v===a+b));
}

// 色
function colorQ(){
 qtext.textContent='赤色を選んでください';
 ['赤','青','緑'].sort(()=>Math.random()-0.5).forEach(v=>btn(v,v==='赤'));
}

// 比較
function compareQ(){
 const a=Math.floor(Math.random()*50),b=Math.floor(Math.random()*50);
 qtext.textContent=`大きい方は？ (${a} / ${b})`;
 btn(a,a>b);btn(b,b>a);
}

// ドラッグ
function dragQ(){
 qtext.textContent='丸を中心に2秒置いてください';
 cv.classList.remove('hidden');
 goal={x:130,y:130,r:30};
 x=30;y=130;
 draw();
 cv.onpointerdown=()=>drag=true;
 cv.onpointerup=()=>{drag=false;if(hold){clearTimeout(hold);hold=null}};
 cv.onpointermove=e=>{
  if(!drag)return;
  const rect=cv.getBoundingClientRect();
  x=e.clientX-rect.left;y=e.clientY-rect.top;
  const d=Math.hypot(x-goal.x,y-goal.y);
  if(d<=goal.r){ if(!hold){ hold=setTimeout(()=>{draw(false);success();},2000);} }
  else{ if(hold){clearTimeout(hold);hold=null;} }
  draw();
 };
}

// ジェスチャー（毎回ランダム・強化版）
function gestureQ(){
 if(!('ontouchstart' in window)) return nextQuestion();
 cv.classList.remove('hidden');
 answers.innerHTML='';
 const patterns=['Z','circle','LRD','UD','zigzag','reverseC'];
 const p=patterns[Math.floor(Math.random()*patterns.length)];
 qtext.textContent='ジェスチャーを描いてください：'+p;
 let path=[];
 ctx.clearRect(0,0,cv.width,cv.height);
 ctx.beginPath();
 cv.onpointerdown=e=>{path=[[e.offsetX,e.offsetY]];drag=true;ctx.moveTo(e.offsetX,e.offsetY)};
 cv.onpointerup=()=>{drag=false;checkGesture(p,path)};
 cv.onpointermove=e=>{
  if(!drag)return;
  path.push([e.offsetX,e.offsetY]);
  ctx.lineTo(e.offsetX,e.offsetY);
  ctx.strokeStyle='#22c55e';
  ctx.stroke();
 };
}

function checkGesture(p,path){
 if(path.length<12) return failure();
 const sx=path[0][0], sy=path[0][1];
 const ex=path[path.length-1][0], ey=path[path.length-1][1];
 const dx=ex-sx, dy=ey-sy;

 switch(p){
  case 'circle':
   if(Math.abs(dx)<30 && Math.abs(dy)<30) return success();
   break;
  case 'Z':
   if(dx>60 && dy>40) return success();
   break;
  case 'LRD':
   if(dx>50 && dy>50) return success();
   break;
  case 'UD':
   if(Math.abs(dx)<30 && dy>70) return success();
   break;
  case 'zigzag':
   if(path.some((p,i)=>i>5 && Math.sign(path[i][0]-path[i-5][0])<0)) return success();
   break;
  case 'reverseC':
   if(dx<0 && Math.abs(dy)<40) return success();
   break;
 }
 failure();
}

function draw(showGoal=true){
 ctx.clearRect(0,0,cv.width,cv.height);
 if(showGoal){ctx.beginPath();ctx.arc(goal.x,goal.y,goal.r,0,Math.PI*2);ctx.strokeStyle='#22c55e';ctx.stroke();}
 ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle='#60a5fa';ctx.fill();
}

function btn(txt,ok){
 const b=document.createElement('button');
 b.textContent=txt;
 b.onclick=()=>ok?success():failure();
 answers.appendChild(b);
}
</script>

</body>
</html>
