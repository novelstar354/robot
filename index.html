<!doctype html>

<html lang="ja">
<head>
<meta charset="utf-8">
<title>人間確認（防御レベルMAX）</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
html,body{margin:0;height:100%;background:#020617;color:#e5ecff;font-family:system-ui}
.wrap{display:grid;place-items:center;height:100%}
.box{background:#0f172a;padding:20px;border-radius:14px;width:340px;text-align:center}
button{padding:10px 16px;border-radius:8px;border:none;background:#2563eb;color:#fff;font-size:14px;margin:4px}
canvas{background:#020617;border-radius:12px;margin-top:12px;touch-action:none}
.hidden{display:none}
.lock{color:#f87171;font-weight:bold}
.small{font-size:11px;opacity:.6;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
 <div class="box">
  <h2>人間確認</h2>
  <label><input type="checkbox" id="chk"> 私はロボットではありません</label>
  <div id="q" class="hidden">
   <p id="qtext"></p>
   <div id="answers"></div>
   <canvas id="cv" width="260" height="260" class="hidden"></canvas>
  </div>
  <p id="msg"></p>
  <div id="fp" class="small"></div>
 </div>
</div>
<script>
let correct=0,fail=0,entropy=0;
const LOCK=5*60*1000;
const chk=document.getElementById('chk');
const q=document.getElementById('q');
const msg=document.getElementById('msg');
const qtext=document.getElementById('qtext');
const answers=document.getElementById('answers');
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d');
const fpEl=document.getElementById('fp');
let goal,x,y,r=12,drag=false,hold=null;

// ===== Fingerprint =====
async function fingerprint(){
const c=document.createElement('canvas');
const x=c.getContext('2d');
x.textBaseline='top';x.font='14px Arial';x.fillText(navigator.userAgent,2,2);
const data=[
navigator.userAgent,
screen.width+'x'+screen.height,
screen.colorDepth,
Intl.DateTimeFormat().resolvedOptions().timeZone,
navigator.language,
navigator.hardwareConcurrency,
navigator.platform,
c.toDataURL()
].join('|');
const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(data));
return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

(async()=>{
const fp=await fingerprint();
const old=localStorage.getItem('fp');
if(old && old!==fp) entropy+=2;
localStorage.setItem('fp',fp);
fpEl.textContent='Fingerprint: '+fp.slice(0,16)+'…';
})();

// Lock
const locked=localStorage.getItem('lock');
if(locked && Date.now()<locked){
msg.innerHTML='<span class="lock">あなたはロボットです<br>5分間ロック中</span>';
chk.disabled=true;
}

chk.onchange=()=>{ if(chk.checked) nextQuestion(); };

function nextQuestion(){
q.classList.remove('hidden');answers.innerHTML='';cv.classList.add('hidden');msg.textContent='';
const base=['calc','color','compare','drag'];
const mobile=('ontouchstart' in window);
if(mobile) base.push('gesture');
const t=base[Math.floor(Math.random()*base.length)];
({calc:calcQ,color:colorQ,compare:compareQ,drag:dragQ,gesture:gestureQ})[t]();
}

function success(){
correct++;q.classList.add('hidden');
if(correct>=3){msg.textContent='確認完了';}
else setTimeout(nextQuestion,400);
}
function failure(){
fail++;correct=0;q.classList.add('hidden');entropy++;
if(fail+entropy>=5){localStorage.setItem('lock',Date.now()+LOCK);
msg.innerHTML='<span class="lock">あなたはロボットです<br>5分間ロック</span>';chk.disabled=true;}
else setTimeout(nextQuestion,400);
}

function btn(txt,ok){const b=document.createElement('button');b.textContent=txt;b.onclick=()=>ok?success():failure();answers.appendChild(b);}

function calcQ(){const a=~~(Math.random()*20),b=~~(Math.random()*20);qtext.textContent=`${a}+${b}は？`;[a+b,a+b+1,a+b-1].sort(()=>Math.random()-.5).forEach(v=>btn(v,v===a+b));}
function colorQ(){qtext.textContent='青色を選んでください';['赤','青','緑','黄'].sort(()=>Math.random()-.5).forEach(v=>btn(v,v==='青'));}
function compareQ(){const a=~~(Math.random()*99),b=~~(Math.random()*99);qtext.textContent=`大きい方は？ (${a}/${b})`;btn(a,a>b);btn(b,b>a);}

function dragQ(){
qtext.textContent='丸を中心に2秒置いてください';cv.classList.remove('hidden');
goal={x:130,y:130,r:30};x=30;y=130;draw();
cv.onpointerdown=()=>drag=true;
cv.onpointerup=()=>{drag=false;if(hold){clearTimeout(hold);hold=null}};
cv.onpointermove=e=>{if(!drag)return;const r=cv.getBoundingClientRect();x=e.clientX-r.left;y=e.clientY-r.top;const d=Math.hypot(x-goal.x,y-goal.y);
if(d<=goal.r){if(!hold)hold=setTimeout(()=>{draw(false);success();},2000);}else{if(hold){clearTimeout(hold);hold=null}}draw();};
}
function draw(show=true){ctx.clearRect(0,0,260,260);if(show){ctx.beginPath();ctx.arc(goal.x,goal.y,goal.r,0,7);ctx.strokeStyle='#22c55e';ctx.stroke();}
ctx.beginPath();ctx.arc(x,y,r,0,7);ctx.fillStyle='#60a5fa';ctx.fill();}

function gestureQ(){
qtext.textContent='右→下→左 にスワイプしてください';let seq=['r','d','l'],i=0,sx,sy;
cv.classList.remove('hidden');ctx.clearRect(0,0,260,260);
cv.onpointerdown=e=>{sx=e.clientX;sy=e.clientY};
cv.onpointerup=e=>{const dx=e.clientX-sx,dy=e.clientY-sy;let g=Math.abs(dx)>Math.abs(dy)?(dx>0?'r':'l'):(dy>0?'d':'u');
if(g===seq[i]){i++;if(i===seq.length)success();}else failure();};
} </script>
</
